
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Michael An">
      
      
        <link rel="canonical" href="https://michael18811380328.github.io/react/reactjs%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E4%B8%8A%E7%AF%87%EF%BC%88%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%89/">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>reactjs源码分析-上篇（首次渲染实现原理） - Michale An Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#ef5552">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reactjs-" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://michael18811380328.github.io/" title="Michale An Blog" class="md-header-nav__button md-logo" aria-label="Michale An Blog">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Michale An Blog
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              reactjs源码分析-上篇（首次渲染实现原理）
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/Michael18811380328/Michael18811380328.github.io/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Michael18811380328/Michael18811380328.github.io
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://michael18811380328.github.io/" title="Michale An Blog" class="md-nav__button md-logo" aria-label="Michale An Blog">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Michale An Blog
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Michael18811380328/Michael18811380328.github.io/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Michael18811380328/Michael18811380328.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" >
      
      <label class="md-nav__link" for="nav-1">
        About
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="nav-1">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        关于我
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../about/log/" class="md-nav__link">
        学习日志
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        文档结构
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
      
      <label class="md-nav__link" for="nav-2">
        Javascript
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Javascript" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          Javascript
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/ES6%20%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8/" class="md-nav__link">
        ES6 迭代器与生成器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/ES6-%E9%98%AE%E4%B8%80%E5%B3%B0/" class="md-nav__link">
        ES6-阮一峰
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/ES6newFeature/" class="md-nav__link">
        ES6newFeature
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/JS%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="md-nav__link">
        JS 性能优化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/JS-testing/" class="md-nav__link">
        JS-testing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/editor-js/" class="md-nav__link">
        editor-js
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/es6/" class="md-nav__link">
        es6
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84ES6%E8%AF%AD%E6%B3%95/" class="md-nav__link">
        常用到的ES6语法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/%E5%89%8D%E7%AB%AF%E8%8B%B1%E8%AF%AD%E5%8D%95%E8%AF%8D/" class="md-nav__link">
        前端英语单词
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        typescript
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="typescript" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          typescript
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/01-%E7%AE%80%E4%BB%8B/" class="md-nav__link">
        01-简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/02-%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        02-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/03-%E8%BF%9B%E9%98%B6/" class="md-nav__link">
        03-进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/04-%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%BC%80%E5%8F%91-%E6%B5%8B%E8%AF%95%E7%BC%96%E8%AF%91/" class="md-nav__link">
        04-工程化开发-测试编译
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/%E7%BD%91%E6%98%93%E4%BA%91%E8%AF%BE%E5%A0%82TS%E5%85%A5%E9%97%A8/" class="md-nav__link">
        网易云课堂TS入门
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/01-%E4%B8%8A%E6%89%8BTypeScript/" class="md-nav__link">
        01-上手TypeScript
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/02-TS-Gulp/" class="md-nav__link">
        02-TS-Gulp
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/03-JavaScript%E8%BF%81%E7%A7%BB/" class="md-nav__link">
        03-JavaScript迁移
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/04-React%20%26%20Webpack/" class="md-nav__link">
        04-React & Webpack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/TS%20%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/" class="md-nav__link">
        TS 常见问题整理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/TypeScript%E7%BC%96%E8%AF%91%E5%99%A8%20%E2%80%93%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%E4%B8%8D%E5%90%AF%E7%94%A8downlevelIteration%EF%BC%9F/" class="md-nav__link">
        TypeScript编译器-downlevelIteration
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/typescript%20%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="md-nav__link">
        typescript 编译选项和配置文件
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
      
      <label class="md-nav__link" for="nav-4">
        react
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="react" data-md-level="1">
        <label class="md-nav__title" for="nav-4">
          <span class="md-nav__icon md-icon"></span>
          react
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../JSzip.md" class="md-nav__link">
        JSzip
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20FAQ/" class="md-nav__link">
        React FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20PureComponent%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="md-nav__link">
        React PureComponent 使用指南
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20%E7%9A%84%20PureComponent%20%E4%B8%8E%20Component/" class="md-nav__link">
        React 的 PureComponent 与 Component
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20%E5%90%84%E7%A7%8Dbug%20%E4%BC%9A%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0/" class="md-nav__link">
        React 各种bug 会实时更新
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6/" class="md-nav__link">
        React 高阶组件
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20%E6%93%8D%E4%BD%9C%E5%85%83%E7%B4%A0%E7%9A%84API/" class="md-nav__link">
        React 操作元素的API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%20%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86/" class="md-nav__link">
        React 中的事件处理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-Design%20Principles/" class="md-nav__link">
        React-Design Principles
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-Hooks/" class="md-nav__link">
        React-Hooks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-Router/" class="md-nav__link">
        React-Router
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-Suspense的实现与探讨-没看明白.md" class="md-nav__link">
        React-Suspense的实现与探讨-没看明白
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-advanced-guides/" class="md-nav__link">
        React-advanced-guides
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-%E9%AB%98%E9%98%B6API/" class="md-nav__link">
        React-高阶API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="md-nav__link">
        React-性能优化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React.Children%E7%9A%84API/" class="md-nav__link">
        React.Children的API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React.Component/" class="md-nav__link">
        React.Component
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React.children%E4%BB%8B%E7%BB%8D/" class="md-nav__link">
        React.children介绍
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%E4%BA%8B%E4%BB%B6/" class="md-nav__link">
        React事件
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%E6%95%B0%E6%8D%AE%E6%B5%81/" class="md-nav__link">
        React数据流
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%E8%8E%B7%E5%8F%96%E5%B0%BA%E5%AF%B8/" class="md-nav__link">
        React获取尺寸
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%E6%96%B0%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F--getDerivedStateFromProps/" class="md-nav__link">
        React新生命周期--getDerivedStateFromProps
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%E4%B8%AD%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" class="md-nav__link">
        React中数据传输
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../React%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B%E5%9B%BE/" class="md-nav__link">
        React生命周期流程图
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Refs%20%26%20DOM/" class="md-nav__link">
        Refs & DOM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getDerivedStateFromProps%E7%9A%84%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        getDerivedStateFromProps的使用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../react%20%E4%B8%AD%E9%80%9A%E8%BF%87ref%E8%8E%B7%E5%8F%96%E9%AB%98%E9%98%B6%EF%BC%88HOC%EF%BC%89%E5%AD%90%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="md-nav__link">
        react 中通过ref获取高阶（HOC）子组件实例的解决方案
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../react%20%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/" class="md-nav__link">
        react 项目结构及编码规范
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../react-responsive/" class="md-nav__link">
        react-responsive
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          reactjs源码分析-上篇（首次渲染实现原理）
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        reactjs源码分析-上篇（首次渲染实现原理）
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    前言
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    入门
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elemetnt" class="md-nav__link">
    引入基本elemetnt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    自定义元素
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    结语
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../reactjs%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E4%B8%8B%E7%AF%87%EF%BC%88%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%89/" class="md-nav__link">
        reactjs源码分析-下篇（更新机制实现原理）
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../text-runner.md" class="md-nav__link">
        text-runner
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%AF%B9React%20children%E7%90%86%E8%A7%A3/" class="md-nav__link">
        对React children理解
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" >
      
      <label class="md-nav__link" for="nav-5">
        工程化
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="工程化" data-md-level="1">
        <label class="md-nav__title" for="nav-5">
          <span class="md-nav__icon md-icon"></span>
          工程化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../git/BUG-Auto%20packing%20the%20repository%20in%20background%20for%20optimum%20performance/" class="md-nav__link">
        BUG-Auto packing the repository in background for optimum performance.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../git/Translation/" class="md-nav__link">
        Translation.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../git/docker-basic-use/" class="md-nav__link">
        docker-basic-use.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../git/markdown-new-style/" class="md-nav__link">
        markdown-new-style.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../project/React%20%26%20Webpack/" class="md-nav__link">
        React & Webpack.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../project/TS-React-Webpack/" class="md-nav__link">
        TS-React-Webpack.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../project/%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7%E7%90%86%E8%AE%BA/" class="md-nav__link">
        前端监控理论.md
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" >
      
      <label class="md-nav__link" for="nav-6">
        课程笔记
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="课程笔记" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          课程笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/00-%E7%9B%AE%E5%BD%95/" class="md-nav__link">
        00-目录.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/02-v8%E5%BC%95%E6%93%8E%E5%9B%9E%E6%94%B6%E5%86%85%E5%AD%98%E7%AE%80%E4%BB%8B/" class="md-nav__link">
        02-v8引擎回收内存简介.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/03-node%E4%B8%8B%E9%9D%A2%E7%9A%84Restful%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        03-node下面的Restful实现.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/04-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%9A%84%E6%8F%90%E5%8D%87%E2%80%94%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E6%88%91%E4%BB%AC%E4%BB%A3%E7%A0%81%E7%9A%84%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7/" class="md-nav__link">
        04-编程思想的提升—如何提高我们代码的可扩展性.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/06-%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86%E5%92%8Cssr/" class="md-nav__link">
        06-浏览器渲染原理和ssr.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/07-%E7%BD%91%E6%98%93%E7%9C%9F%E5%AE%9E%E9%A1%B9%E7%9B%AEwebpack%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        07-网易真实项目webpack配置解析.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/08-%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90API%E5%B1%82/" class="md-nav__link">
        08-从架构分析API层.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/09-%E5%89%8D%E7%AB%AF%E8%B4%9F%E8%B4%A3%E4%BA%BA%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9/" class="md-nav__link">
        09-前端负责人的工作内容.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/10-%E5%88%86%E6%9E%90%E6%BA%90%E7%A0%81%E5%AD%A6%E6%9E%B6%E6%9E%84/" class="md-nav__link">
        10-分析源码学架构.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/11-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E9%AB%98%E8%B4%A8%E9%87%8F%E4%BB%A3%E7%A0%81/" class="md-nav__link">
        11-设计模式高质量代码.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/12-nodeJS%2BMongoDB%E7%99%BB%E5%BD%95%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
        12-nodeJS+MongoDB登录系统.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/12-nodejs-mongodb-mongoose/" class="md-nav__link">
        12-nodejs-mongodb-mongoose.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/13-%E4%BD%BF%E7%94%A8VUE%E5%88%9B%E5%BB%BA%E7%BB%84%E4%BB%B6%EF%BC%88%E6%B2%A1%E5%AD%A6%E5%AE%8C%EF%BC%89/" class="md-nav__link">
        13-使用VUE创建组件（没学完）.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/16-%E6%9E%84%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E8%84%9A%E6%89%8B%E6%9E%B6%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        16-构建自己的脚手架工具.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/17-webpack%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" class="md-nav__link">
        17-webpack编译原理分析.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/20-%E7%BB%84%E4%BB%B6%E5%B0%81%E8%A3%85%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%8A%80%E8%83%BD-VUE%EF%BC%88%E6%B2%A1%E5%AD%A6%E5%AE%8C%EF%BC%89/" class="md-nav__link">
        20-组件封装的基本技能-VUE（没学完）.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/21-ssr/" class="md-nav__link">
        21-ssr.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/24-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%A6%82%E4%BD%95%E5%81%9A/" class="md-nav__link">
        24-单元测试如何做.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/25-%E5%9F%BA%E4%BA%8ENodeJS%E6%89%93%E9%80%A0Web%E6%9E%B6%E6%9E%84%E4%B8%AD%E9%97%B4%E5%B1%82/" class="md-nav__link">
        25-基于NodeJS打造Web架构中间层.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../netease/26-webpack%E7%9A%84%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        26-webpack的高级技巧.md
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    前言
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    入门
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elemetnt" class="md-nav__link">
    引入基本elemetnt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    自定义元素
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    结语
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Michael18811380328/Michael18811380328.github.io/edit/master/docs/react/reactjs源码分析-上篇（首次渲染实现原理）.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="reactjs-"><a href="http://purplebamboo.github.io/2015/09/15/reactjs_source_analyze_part_one/">reactjs源码分析-上篇（首次渲染实现原理）</a><a class="headerlink" href="#reactjs-" title="Permanent link">&para;</a></h1>
<p>reactjs是目前比较火的前端框架，但是目前并没有很好的解释原理的项目。reactjs源码比较复杂不适合初学者去学习。所以本文通过实现一套简易版的reactjs，使得理解原理更加容易。</p>
<p>所有实例源码都托管在github。<a href="https://github.com/purplebamboo/little-reactjs">点这里</a>里面有分步骤的例子，可以一边看一边运行例子。</p>
<p>这个帖子是2015年，需要考虑是否符合最新的版本，知识是否过时</p>
<h2 id="_1">前言<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>前端的发展特别快，经历过jQuery一统天下的工具库时代后，现在各种框架又开始百家争鸣了。angular，ember，backbone，vue，avalon，ploymer还有reactjs，作为一个前端真是稍不留神就感觉要被淘汰了，就在去年大家还都是angularjs的粉丝，到了今年又开始各种狂追reactjs了。前端都是喜新厌旧的，不知道最后这些框架由谁来一统天下，用句很俗的话说，这是最好的时代也是最坏的时代。作为一个前端，只能多学点，尽量多的了解他们的原理。</p>
<p>reactjs的代码非常绕，对于没有后台开发经验的前端来说看起来会比较吃力。其实reactjs的核心内容并不多，主要是下面这些：</p>
<ul>
<li>虚拟dom对象(Virtual DOM)</li>
<li>虚拟dom差异化算法（diff algorithm）</li>
<li>单向数据流渲染（Data Flow）</li>
<li>组件生命周期</li>
<li>事件处理</li>
</ul>
<p>下面我们将一点点的来实现一个简易版的reactjs，实现上面的那些功能，最后用这个reactjs做一个todolist的小应用，看完这个，或者跟着敲一遍代码。希望让大家能够更好的理解reactjs的运行原理。</p>
<h2 id="_2">入门<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>我们先从渲染hello world开始吧。</p>
<p>我们看下面的代码：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
  <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">,</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;container&quot;</span><span class="p">))</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>

<span class="cm">/**</span>
<span class="cm">对应的html为</span>

<span class="cm">&lt;div id=&quot;container&quot;&gt;&lt;/div&gt;</span>


<span class="cm">生成后的html为：</span>

<span class="cm">&lt;div id=&quot;container&quot;&gt;</span>
<span class="cm">    &lt;span data-reactid=&quot;0&quot;&gt;hello world&lt;/span&gt;</span>
<span class="cm">&lt;/div&gt;</span>

<span class="cm">*/</span>
</code></pre></div>
<p>假定这一行代码,就可以把<code>hello world</code>渲染到对应的div里面。</p>
<p>我们来看看我们需要为此做些什么：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//component类，用来表示文本在渲染，更新，删除时应该做些什么事情</span>
<span class="kd">function</span> <span class="nx">ReactDOMTextComponent</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//存下当前的字符串</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">;</span>
  <span class="c1">//用来标识当前component</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//component渲染时生成的dom结构</span>
<span class="nx">ReactDOMTextComponent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mountComponent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rootID</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">=</span> <span class="nx">rootID</span><span class="p">;</span>
  <span class="k">return</span> <span class="s1">&#39;&lt;span data-reactid=&quot;&#39;</span> <span class="o">+</span> <span class="nx">rootID</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span> <span class="o">+</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//component工厂  用来返回一个component实例</span>
<span class="kd">function</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactDOMTextComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">React</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">nextReactRootIndex</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span><span class="nx">container</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">componentInstance</span> <span class="o">=</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">markup</span> <span class="o">=</span> <span class="nx">componentInstance</span><span class="p">.</span><span class="nx">mountComponent</span><span class="p">(</span><span class="nx">React</span><span class="p">.</span><span class="nx">nextReactRootIndex</span><span class="o">++</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">markup</span><span class="p">);</span>
    <span class="c1">//触发完成mount的事件</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;mountReady&#39;</span><span class="p">);</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>代码分为三个部分：</p>
<ol>
<li>React.render 作为入口负责调用渲染</li>
<li>我们引入了component类的概念，ReactDOMTextComponent是一个component类定义，定义对于这种<code>文本类型</code>的节点，在渲染，更新，删除时应该做什么操作，这边暂时只用到渲染，另外两个可以先忽略</li>
<li>instantiateReactComponent用来根据element的类型（现在只有一种string类型），返回一个component的实例。其实就是个类工厂。</li>
</ol>
<p>nextReactRootIndex作为每个component的标识id，不断加1，确保唯一性。这样我们以后可以通过这个标识找到这个元素。</p>
<p>可以看到我们把逻辑分为几个部分，主要的渲染逻辑放在了具体的componet类去定义。React.render负责调度整个流程，这里是调用instantiateReactComponent生成一个对应component类型的实例对象，然后调用此对象的mountComponent获取生成的内容。最后写到对应的container节点中。</p>
<p>可能有人问，这么p大点功能，有必要这么复杂嘛，别急。往下看才能体会这种分层的好处。</p>
<h2 id="elemetnt">引入基本elemetnt<a class="headerlink" href="#elemetnt" title="Permanent link">&para;</a></h2>
<p>我们知道reactjs最大的卖点就是它的虚拟dom概念，我们一般使用<code>React.createElement</code>来创建一个虚拟dom元素。</p>
<p>虚拟dom元素分为两种，一种是浏览器自带的基本元素比如 div p input form 这种，一种是自定义的元素。</p>
<blockquote>
<p>这边需要说一下我们上节提到的文本节点，它不算虚拟dom，但是reacjs为了保持渲染的一致性。文本节点是在外面包了一层span标记，也给它配了个简化版component（ReactDOMTextComponent）。</p>
</blockquote>
<p>这节我们先讨论浏览器的基本元素。</p>
<p>在reactjs里，当我们希望在hello world外面包一层div,并且带上一些属性，甚至事件时我们可以这么写：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//演示事件监听怎么用</span>
<span class="kd">function</span> <span class="nx">hello</span><span class="p">(){</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,{</span><span class="nx">id</span><span class="o">:</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="nx">onclick</span><span class="o">:</span><span class="nx">hello</span><span class="p">},</span><span class="s1">&#39;click me&#39;</span><span class="p">)</span>
<span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;container&quot;</span><span class="p">))</span>

<span class="cm">/**</span>

<span class="cm">//生成的html为：</span>

<span class="cm">&lt;div data-reactid=&quot;0&quot; id=&quot;test&quot;&gt;</span>
<span class="cm">    &lt;span data-reactid=&quot;0.0&quot;&gt;click me&lt;/span&gt;</span>
<span class="cm">&lt;/div&gt;</span>
<span class="cm">//点击文字，会弹出hello的对话框</span>
<span class="cm">*/</span>
</code></pre></div>
<p>上面使用<code>React.createElement</code>创建了一个基本元素，我们来看看简易版本<code>React.createElement</code>的实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//ReactElement就是虚拟dom的概念，具有一个type属性代表当前的节点类型，还有节点的属性props</span>
<span class="c1">//比如对于div这样的节点type就是div，props就是那些attributes</span>
<span class="c1">//另外这里的key,可以用来标识这个element，用于优化以后的更新，这里可以先不管，知道有这么个东西就好了</span>
<span class="kd">function</span> <span class="nx">ReactElement</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">props</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
<span class="p">}</span>


<span class="nx">React</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">nextReactRootIndex</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span>
  <span class="nx">createElement</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">config</span><span class="p">,</span><span class="nx">children</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="p">{},</span><span class="nx">propName</span><span class="p">;</span>
    <span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="c1">//看有没有key，用来标识element的类型，方便以后高效的更新，这里可以先不管</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">key</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">//复制config里的内容到props</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">propName</span> <span class="k">in</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">propName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">propName</span> <span class="o">!==</span> <span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">props</span><span class="p">[</span><span class="nx">propName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">config</span><span class="p">[</span><span class="nx">propName</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//处理children,全部挂载到props的children属性上</span>
    <span class="c1">//支持两种写法，如果只有一个参数，直接赋值给children，否则做合并处理</span>
    <span class="kd">var</span> <span class="nx">childrenLength</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mf">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">childrenLength</span> <span class="o">===</span> <span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">props</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="o">?</span> <span class="nx">children</span> <span class="o">:</span> <span class="p">[</span><span class="nx">children</span><span class="p">]</span> <span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">childrenLength</span> <span class="o">&gt;</span> <span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">childArray</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">childrenLength</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">childrenLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">childArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mf">2</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">props</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">childArray</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactElement</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span><span class="nx">props</span><span class="p">);</span>

  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span><span class="nx">container</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">componentInstance</span> <span class="o">=</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">markup</span> <span class="o">=</span> <span class="nx">componentInstance</span><span class="p">.</span><span class="nx">mountComponent</span><span class="p">(</span><span class="nx">React</span><span class="p">.</span><span class="nx">nextReactRootIndex</span><span class="o">++</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">markup</span><span class="p">);</span>
    <span class="c1">//触发完成mount的事件</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;mountReady&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>createElement只是做了简单的参数修正，最终返回一个ReactElement实例对象也就是我们说的虚拟元素的实例。</p>
<blockquote>
<p>这里注意key的定义，主要是为了以后更新时优化效率，这边可以先不管忽略。</p>
</blockquote>
<p>好了有了元素实例，我们得把他渲染出来，此时render接受的是一个ReactElement而不是文本，我们先改造下instantiateReactComponent：</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
  <span class="c1">//文本节点的情况</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactDOMTextComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//浏览器默认节点的情况</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">){</span>
    <span class="c1">//注意这里，使用了一种新的component</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactDOMComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>我们增加了一个判断，这样当render的不是文本而是浏览器的基本元素时。我们使用另外一种component来处理它渲染时应该返回的内容。这里就体现了工厂方法instantiateReactComponent的好处了，不管来了什么类型的node，都可以负责生产出一个负责渲染的component实例。这样render完全不需要做任何修改，只需要再做一种对应的component类型（这里是ReactDOMComponent）就行了。</p>
<p>所以重点我们来看看<code>ReactDOMComponent</code>的具体实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//component类，用来表示文本在渲染，更新，删除时应该做些什么事情</span>
<span class="kd">function</span> <span class="nx">ReactDOMComponent</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
  <span class="c1">//存下当前的element对象引用</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//component渲染时生成的dom结构</span>
<span class="nx">ReactDOMComponent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mountComponent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rootID</span><span class="p">){</span>
  <span class="c1">//赋值标识</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">=</span> <span class="nx">rootID</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">tagOpen</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">tagClose</span> <span class="o">=</span> <span class="s1">&#39;&lt;/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>

  <span class="c1">//加上reactid标识</span>
  <span class="nx">tagOpen</span> <span class="o">+=</span> <span class="s1">&#39; data-reactid=&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span><span class="p">;</span>

  <span class="c1">//拼凑出属性</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">propKey</span> <span class="k">in</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//这里要做一下事件的监听，就是从属性props里面解析拿出on开头的事件属性的对应事件监听</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/^on[A-Za-z]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">propKey</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">eventType</span> <span class="o">=</span> <span class="nx">propKey</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="c1">//针对当前的节点添加事件代理,以_rootNodeID为命名空间</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">delegate</span><span class="p">(</span><span class="s1">&#39;[data-reactid=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">,</span> <span class="nx">eventType</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span><span class="p">,</span> <span class="nx">props</span><span class="p">[</span><span class="nx">propKey</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="c1">//对于children属性以及事件监听的属性不需要进行字符串拼接</span>
    <span class="c1">//事件会代理到全局。这边不能拼到dom上不然会产生原生的事件监听</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">[</span><span class="nx">propKey</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">propKey</span> <span class="o">!=</span> <span class="s1">&#39;children&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/^on[A-Za-z]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">propKey</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">tagOpen</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">propKey</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">props</span><span class="p">[</span><span class="nx">propKey</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//获取子节点渲染出的内容</span>
  <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">children</span> <span class="o">||</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">childrenInstances</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">//用于保存所有的子节点的componet实例，以后会用到</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">children</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//这里再次调用了instantiateReactComponent实例化子节点component类，拼接好返回</span>
    <span class="kd">var</span> <span class="nx">childComponentInstance</span> <span class="o">=</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">childComponentInstance</span><span class="p">.</span><span class="nx">_mountIndex</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>

    <span class="nx">childrenInstances</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">childComponentInstance</span><span class="p">);</span>
    <span class="c1">//子节点的rootId是父节点的rootId加上新的key也就是顺序的值拼成的新值</span>
    <span class="kd">var</span> <span class="nx">curRootId</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
    <span class="c1">//得到子节点的渲染内容</span>
    <span class="kd">var</span> <span class="nx">childMarkup</span> <span class="o">=</span> <span class="nx">childComponentInstance</span><span class="p">.</span><span class="nx">mountComponent</span><span class="p">(</span><span class="nx">curRootId</span><span class="p">);</span>
    <span class="c1">//拼接在一起</span>
    <span class="nx">content</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">childMarkup</span><span class="p">;</span>
  <span class="p">})</span>

  <span class="c1">//留给以后更新时用的这边先不用管</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_renderedChildren</span> <span class="o">=</span> <span class="nx">childrenInstances</span><span class="p">;</span>

  <span class="c1">//拼出整个html内容</span>
  <span class="k">return</span> <span class="nx">tagOpen</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="nx">content</span> <span class="o">+</span> <span class="nx">tagClose</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>我们增加了虚拟dom reactElement的定义，增加了一个新的componet类ReactDOMComponent。
这样我们就实现了渲染浏览器基本元素的功能了。</p>
<p>对于虚拟dom的渲染逻辑，本质上还是个递归渲染的东西，reactElement会递归渲染自己的子节点。可以看到我们通过instantiateReactComponent屏蔽了子节点的差异，只需要使用不同的componet类，这样都能保证通过mountComponent最终拿到渲染后的内容。</p>
<p>另外这边的事件也要说下，可以在传递props的时候传入{onClick:function(){}}这样的参数，这样就会在当前元素上添加事件，代理到document。由于reactjs本身全是在写js，所以监听的函数的传递变得特别简单。</p>
<blockquote>
<p>这里很多东西没有考虑，比如一些特殊的类型input select等等，再比如img不需要有对应的tagClose等。这里为了保持简单就不再扩展了。另外reactjs的事件处理其实很复杂，实现了一套标准的w3c事件。这里偷懒直接使用jQuery的事件代理到document上了。</p>
</blockquote>
<h2 id="_3">自定义元素<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>上面实现了基本的元素内容，我们下面实现自定义元素的功能。</p>
<p>随着前端技术的发展浏览器的那些基本元素已经满足不了我们的需求了，如果你对<a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components">webcomponents</a>有一定的了解，就会知道人们一直在尝试扩展一些自己的标记。</p>
<p>reactjs通过虚拟dom做到了类似的功能，还记得我们上面element.type只是个简单的字符串，如果是个类呢？如果这个类恰好还有自己的生命周期管理，那扩展性就很高了。</p>
<blockquote>
<p>如果对生命周期等概念不是很理解的，可以看看我以前的另一片文章：<a href="http://www.html-js.com/article/2760">javascript组件化</a></p>
</blockquote>
<p>我们看下reactjs怎么使用自定义元素：</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">HelloMessage</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
  <span class="nx">getInitialState</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;say:&#39;</span><span class="p">};</span>
  <span class="p">},</span>
  <span class="nx">componentWillMount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;我就要开始渲染了。。。&#39;</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">componentDidMount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;我已经渲染好了。。。&#39;</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="s2">&quot;Hello &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">HelloMessage</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">}),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;container&quot;</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm">结果为：</span>

<span class="cm">html:</span>
<span class="cm">&lt;div data-reactid=&quot;0&quot;&gt;</span>
<span class="cm">    &lt;span data-reactid=&quot;0.0&quot;&gt;say:&lt;/span&gt;</span>
<span class="cm">    &lt;span data-reactid=&quot;0.1&quot;&gt;Hello &lt;/span&gt;</span>
<span class="cm">    &lt;span data-reactid=&quot;0.2&quot;&gt;John&lt;/span&gt;</span>
<span class="cm">&lt;/div&gt;</span>

<span class="cm">console:</span>
<span class="cm">我就要开始渲染了。。。</span>
<span class="cm">我已经渲染好了。。。</span>

<span class="cm">*/</span>
</code></pre></div>
<p><code>React.createElement</code>接受的不再是字符串，而是一个class。</p>
<p><code>React.createClass</code>生成一个自定义标记类，带有基本的生命周期：</p>
<ul>
<li>getInitialState 获取最初的属性值this.state</li>
<li>componentWillmount 在组件准备渲染时调用</li>
<li>componentDidMount 在组件渲染完成后调用</li>
</ul>
<p>对reactjs稍微有点了解的应该都可以明白上面的用法。</p>
<p>我们先来看看React.createClass的实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//定义ReactClass类,所有自定义的超级父类</span>
<span class="kd">var</span> <span class="nx">ReactClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
<span class="p">}</span>
<span class="c1">//留给子类去继承覆盖</span>
<span class="nx">ReactClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>



<span class="nx">React</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">nextReactRootIndex</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span>
  <span class="nx">createClass</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">spec</span><span class="p">){</span>
    <span class="c1">//生成一个子类</span>
    <span class="kd">var</span> <span class="nx">Constructor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getInitialState</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">getInitialState</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//原型继承，继承超级父类</span>
    <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReactClass</span><span class="p">();</span>
    <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Constructor</span><span class="p">;</span>
    <span class="c1">//混入spec到原型</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span><span class="nx">spec</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">Constructor</span><span class="p">;</span>

  <span class="p">},</span>
  <span class="nx">createElement</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">config</span><span class="p">,</span><span class="nx">children</span><span class="p">){</span>
    <span class="p">...</span>
  <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span><span class="nx">container</span><span class="p">){</span>
      <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>可以看到createClass生成了一个继承ReactClass的子类，在构造函数里调用this.getInitialState获得最初的state。</p>
<blockquote>
<p>为了演示方便,我们这边的ReactClass相当简单，实际上原始的代码处理了很多东西，比如类的mixin的组合继承支持,比如componentDidMount等可以定义多次，需要合并调用等等，有兴趣的去翻源码吧，不是本文的主要目的，这里就不详细展开了。</p>
</blockquote>
<p>我们这里只是返回了一个继承类的定义，那么具体的componentWillmount，这些生命周期函数在哪里调用呢。</p>
<p>看看我们上面的两种类型就知道，我们是时候为自定义元素也提供一个componet类了，在那个类里我们会实例化ReactClass，并且管理生命周期，还有父子组件依赖。</p>
<p>好，我们老规矩先改造instantiateReactComponent</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
  <span class="c1">//文本节点的情况</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactDOMTextComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//浏览器默认节点的情况</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">){</span>
    <span class="c1">//注意这里，使用了一种新的component</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactDOMComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

  <span class="p">}</span>
  <span class="c1">//自定义的元素节点</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
    <span class="c1">//注意这里，使用新的component,专门针对自定义元素</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ReactCompositeComponent</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>很简单我们增加了一个判断，使用新的component类形来处理自定义的节点。我们看下
ReactCompositeComponent的具体实现:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">ReactCompositeComponent</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
  <span class="c1">//存放元素element对象</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
  <span class="c1">//存放唯一标识</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="c1">//存放对应的ReactClass的实例</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_instance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//用于返回当前自定义元素渲染时应该返回的内容</span>
<span class="nx">ReactCompositeComponent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mountComponent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rootID</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span> <span class="o">=</span> <span class="nx">rootID</span><span class="p">;</span>
  <span class="c1">//拿到当前元素对应的属性值</span>
  <span class="kd">var</span> <span class="nx">publicProps</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="c1">//拿到对应的ReactClass</span>
  <span class="kd">var</span> <span class="nx">ReactClass</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentElement</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
  <span class="c1">// Initialize the public class</span>
  <span class="kd">var</span> <span class="nx">inst</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReactClass</span><span class="p">(</span><span class="nx">publicProps</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_instance</span> <span class="o">=</span> <span class="nx">inst</span><span class="p">;</span>
  <span class="c1">//保留对当前comonent的引用，下面更新会用到</span>
  <span class="nx">inst</span><span class="p">.</span><span class="nx">_reactInternalInstance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">componentWillMount</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">inst</span><span class="p">.</span><span class="nx">componentWillMount</span><span class="p">();</span>
    <span class="c1">//这里在原始的reactjs其实还有一层处理，就是  componentWillMount调用setstate，不会触发rerender而是自动提前合并，这里为了保持简单，就略去了</span>
  <span class="p">}</span>
  <span class="c1">//调用ReactClass的实例的render方法,返回一个element或者一个文本节点</span>
  <span class="kd">var</span> <span class="nx">renderedElement</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_instance</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="c1">//得到renderedElement对应的component类实例</span>
  <span class="kd">var</span> <span class="nx">renderedComponentInstance</span> <span class="o">=</span> <span class="nx">instantiateReactComponent</span><span class="p">(</span><span class="nx">renderedElement</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_renderedComponent</span> <span class="o">=</span> <span class="nx">renderedComponentInstance</span><span class="p">;</span> <span class="c1">//存起来留作后用</span>

  <span class="c1">//拿到渲染之后的字符串内容，将当前的_rootNodeID传给render出的节点</span>
  <span class="kd">var</span> <span class="nx">renderedMarkup</span> <span class="o">=</span> <span class="nx">renderedComponentInstance</span><span class="p">.</span><span class="nx">mountComponent</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_rootNodeID</span><span class="p">);</span>

  <span class="c1">//之前我们在React.render方法最后触发了mountReady事件，所以这里可以监听，在渲染完成后会触发。</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mountReady&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//调用inst.componentDidMount</span>
    <span class="nx">inst</span><span class="p">.</span><span class="nx">componentDidMount</span> <span class="o">&amp;&amp;</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">componentDidMount</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">renderedMarkup</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>实现并不难，ReactClass的render一定是返回一个虚拟节点(包括element和text)，这个时候我们使用instantiateReactComponent去得到实例，再使用mountComponent拿到结果作为当前自定义元素的结果。</p>
<p>应该说本身自定义元素不负责具体的内容，他更多的是负责生命周期。具体的内容是由它的render方法返回的虚拟节点来负责渲染的。</p>
<p>本质上也是递归的去渲染内容的过程。同时因为这种递归的特性，父组件的componentWillMount一定在某个子组件的componentWillMount之前调用，而父组件的componentDidMount肯定在子组件之后，因为监听mountReady事件，肯定是子组件先监听的。</p>
<blockquote>
<p>需要注意的是自定义元素并不会处理我们createElement时传入的子节点，它只会处理自己render返回的节点作为自己的子节点。不过我们在render时可以使用this.props.children拿到那些传入的子节点，可以自己处理。其实有点类似webcomponents里面的shadow dom的作用。</p>
</blockquote>
<p>上面实现了三种类型的元素，其实我们发现本质上没有太大的区别，都是有自己对应component类来处理自己的渲染过程。</p>
<p>大概的关系是下面这样。</p>
<p><img alt="结构图" src="https://img.alicdn.com/tps/TB1NPA_JpXXXXcVXXXXXXXXXXXX-1024-768.jpg" /></p>
<p>于是我们发现初始化的渲染流程都已经完成了。</p>
<h2 id="_4">结语<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>整个初次渲染的流程基本就分析完毕了。看看我们目前的进展，事件监听做了，虚拟dom有了。基本的组件生命周期也有了。我们这个小玩具已经可以简单跑跑了。下篇文章我们将一起去实现reactjs的更新机制，看看它最核心的diff算法是怎么回事。</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../react-responsive/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                react-responsive
              </div>
            </div>
          </a>
        
        
          <a href="../reactjs%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E4%B8%8B%E7%AF%87%EF%BC%88%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%89/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                reactjs源码分析-下篇（更新机制实现原理）
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; Michael An
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../js/baidu-statistics.js"></script>
      
    
  </body>
</html>